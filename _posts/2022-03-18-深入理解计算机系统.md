# 深入理解计算机系统



## 计算机系统漫游

- 系统中所有信息，都是一串比特表示的，区分不同数据对象的唯一方法是我们读到这些数据对象的上下文
  - 磁盘文件
  - 内存中的数据
  - 网络传送的数据
- 系统花费大量的时间把信息从一个地方搬运到另一个地方
- 抽象是计算机最重要的概念
  - 处理器里，指令集架构提供抽象，机器代码表现得就好像运行在一个一次只执行一条指令的处理器上。而底层的硬件比抽象描述要复杂的多，可以并发的执行多条指令



## 信息的表示和处理

- 整数运算和浮点数运算会有不同的数学属性是因为他们处理数字表示有限性的方式不同
  - 整数表示一个相对小的数值范围，但是精确
  - 浮点数编码一个较大的范围，但是近似
- 跨越多字节的程序对象
  - 这个对象的地址是什么
  - 在内存中如何排列这些字节
- 计算机系统的一个基本概念
  - 从机器的角度，程序仅仅是字节序列，机器没有关于原始程序的任何信息
  - 符号数和非符号数之间的转换：底层的位表示不变



## 程序的机器级表示

- 精通细节是理解更深和更基本概念的先决条件
- 理解产生的汇编和原始代码之间的关系，关键是找到程序值和寄存器之间的映射关系
- 寄存器是唯一被所有过程共享的资源
- 结构中的各个字段的选取完全是在编译时处理的，机器代码不包括关于字段的任何信息
- 任何内存分配函数（alloca，malloc）生成的块的起始地址都必须是16的倍数
- DDD:Data Display Debugger



## 处理器体系结构

- 定义
  - 一个处理器支持的指令和指令的字节级编码称为它的指令集体系结构
    - 定位各种状态单元
    - 指令集
    - 指令集编码
    - 异常事件处理
- 性质
  - 字节编码必须有唯一的解释
  - 执行一条指令是需要进行很多处理的
- 分类
  - 复杂指令集
  - 精简指令集
- 操作
  - 取指
  - 译码
  - 执行
  - 访存
  - 写回
  - 更新PC
- 流水线
  - 提高了系统的吞吐量（单位时间内服务的顾客总数）
  - 轻微增加延迟（服务一个用户所需要的时间）
  - 由不一致的阶段延迟造成的流水线技术的局限性，系统的吞吐量受最慢阶段的速度所致
  - 这里需要多次重复学习



## 优化程序性能

- 选择一组适当的算法和数据结构
- 必须编写出编译器能够有效优化以转换成高效可执行代码的源码
- 并行性
- 优化编译器的能力和局限
- 最好的办法：实验加上分析，反复尝试不同的办法，进行测量，检查汇编代码表示以确定底层的性能瓶颈
- 策略
  - 消除循环的低效率
    - 把循环内部计算为固定值的代码，移到循环外
    - 循环展开
      - 减少不直接有助于程序结果的操作数量
      - 提供一些办法，进一步变化代码，减少整个计算中关键路径上的操作数量
  - 减少过程调用
    - 延迟：表示完成运算所需要的总时间
    - 发射时间：两个连续的同类型的运算之间需要的最小时钟周期数
    - 容量：能够执行该运算的功能单元的数量
- 微处理器取得功绩之一：采用复杂而奇异的微处理器结构，其中多条指令可以并行地执行，同时又呈现出一种简单的顺序执行指令的现象



## 存储器层次结构

- 一个编写良好的计算机程序常常具有良好的局部性
- 缓存不命中的分类
  - 冷不命中：一个空的缓存
  - 冲突不命中
- 高速缓存的分类
  - 直接映射高速缓存
  - 组相连高速缓存
- 编写高速缓存友好的代码
  - 让常见的情况运行得快
  - 尽量减小每一个循环内部的缓存不命中数量



## 链接

- 作用
  - 将各种代码和数据片段收集并组合成为一个单一文件的过程
  - 使得分离编译成为可能，分解为更小、更好管理的模块
- 时机
  - 编译时
  - 加载时
  - 运行时
- 连接器的主要任务
  - 符号解析（链接器如何解析多重定义的全局符号）
    - 不允许有多个同名的强符号
    - 如果有一个强符号和多个弱符号同名，则选择强符号
    - 如果有多个弱符号，则任意选择一个
  - 重定位
    - 重定位节和符号定义
    - 重定位节中的符号引用（重定位条目）
- 目标文件
  - 可重定位目标文件
    - 文件格式？
    - 符号和符号表：符号类型
      - 由模块定义并能被其他模块引用的全局符号
      - 其他模块定义被模块m引用的全局符号
      - 只被模块m定义和引用的局部符号
  - 可执行目标文件
  - 共享目标文件





## 异常控制



## 虚拟内存



## 系统I/O



## 网络编程





## 并发编程





